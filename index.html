<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=1024">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Making Full Use of the Client Resource Management Framework | Day of DotNetNuke, Charlotte, June 2, 2012 | by Brian Dukes @BrianDukes</title>
    
    <meta name="description" content="DotNetNuke 6.1 introduced the Client Resource Management framework to give developers and skinners a central mechanism for managing JavaScript and CSS that needs to be included in your site. The framework enables us to think about our scripts and styles much more logically, and leave the worries of optimizing behind. In this presentation, I’ll introduce the framework, show how and why to use it, and point out some tips and tricks to make it easier to use and manage.">
    <meta name="author" content="Brian Dukes">

    <link href="http://fonts.googleapis.com/css?family=Open+Sans:regular,semibold,italic,italicsemibold" rel="stylesheet">
    <link href="css/combined-styles.css" rel="stylesheet">
    
    <link rel="shortcut icon" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
</head>
<body class="impress-not-supported">
<div class="fallback-message">
    <p>Your browser <strong>doesn't support the features required</strong> by impress.js, so you are presented with a simplified version of this presentation.</p>
    <p>For the best experience please use the latest version of one of the following browsers:</p>
    <div id="fallback-browsers">
        <ul>
            <li><a href="http://www.google.com/chrome/">Chrome</a></li>
            <li><a href="http://www.apple.com/safari/">Safari</a></li>
            <li><a href="http://www.firefox.com/">Firefox</a></li>
        </ul>
    </div>
</div>
<div id="impress">
    <div id="title" class="step slide" data-x="-500">
        <hgroup>
            <h1>Making Full Use of the Client Resource Management Framework</h1>
            <h2>Brian Dukes, Engage Software</h2>
            <h3>Charlotte Day of DotNetNuke 2012</h3>
        </hgroup>
        <p class="sponsors">
            <a href="http://www.dotnetnuke.com/"><img src="img/DotNetNuke.png" alt="DotNetNuke" /></a>
            <a href="http://www.PowerDNN.com/"><img src="img/PowerDnn.png" alt="PowerDNN" /></a>
        </p>
    </div>
    <div id="agenda" class="step" data-x="1000" data-rotate="90">
        <q><strong>What</strong> is this thing?</q>
        <q><strong>How</strong> do I use this thing?</q>
        <q><strong>Why</strong> should I use this thing?</q>
        <q>What are the <strong>tips</strong> and <strong>gotchas</strong>?</q>
    </div>
    <!--div id="prerequisites" class="step second-step" data-x="1000" data-z="-1000">
        <h3>Prerequisites</h3>
        <ul>
            <li>Familiarity with <strong><abbr title="DotNetNuke">DNN</abbr> module development</strong></li>
            <li>Familiarity with web development (<strong><abbr title="HyperText Markup Language">HTML</abbr>, <abbr title="Cascading Style Sheets">CSS</abbr>, <abbr title="JavaScript">JS</abbr></strong>)</li>
        </ul>
    </div-->
    <div id="features" class="step" data-x="2000">
        <hgroup>
            <h3>Framework Features</h3>
            <h4>What are we talking about here?</h4>
        </hgroup>
        <ul>
            <li>Combination</li>
            <li>Minification</li>
            <li>Cache Busting</li>
            <li>De-duplication</li>
            <li>Placement</li>
            <li>Priority</li>
        </ul>
    </div>
    <div id="control-registration" class="step" data-x="3000">
        <h3>Control Registration</h3>
        GOTCHA: No Local Paths
    </div>
    <div id="code-registration" class="step" data-x="4000">
        <h3>Code Registration</h3>
    </div>
    <div id="why-combine" class="step" data-x="5000">
        <h3>Combination</h3>
        HTTP Requests are bad
    </div>
    <div id="why-minify" class="step" data-x="6000">
        <h3>Minification</h3>
        Big files are bad
    </div>
    <div id="why-cache-bust" class="step" data-x="7000">
        <h3>Cache Busting</h3>
        Old files are bad
    </div>
    <div id="performance" class="step" data-x="8000">
        <h3>Performance</h3>
        Yay!
    </div>
    <div id="tricks" class="step" data-x="9000">
        <h3>Tricks</h3>
        <ul>
            <li>Organize!</li>
            <li>Priority</li>
            <li>DnnFormBottomProvider</li>
            <li>Use the features</li>
            <li><a href="http://www.dotnetnuke.com/Resources/Wiki/Page/Client-Resource-Management-API.aspx">http://www.dotnetnuke.com/Resources/Wiki/Page/Client-Resource-Management-API.aspx</a></li>
            <!--
Overview»
There are two primary reasons for discussing the topic of client resource management:

    Performance is a feature (fast sites lead to satisfied users)
    DotNetNuke has been largely optimized on the server side, not so much on the client side


Here is a wonderful quote from the Yahoo! Exceptional Performance Team about the performance of web sites:

80% of the end-user response time is spent on the front-end. Most of this time is tied up in downloading all the components in the page: images, stylesheets, scripts, Flash, etc. Reducing the number of components in turn reduces the number of HTTP requests required to render the page. This is the key to faster pages.

With that in mind, the state of DotNetNuke 6.0, brand new installation, home page:

    Unauthenticated: 6 CSS Files and 13 JavaScript files (total: 19)
    Logged in as host: 8 CSS Files and 22 JavaScript files (total: 30)


Obviously there is room for improvement!

Getting Started»
Please review how to How to Enable Client Resource Management

Overall Strategy»
DotNetNuke 6.1 represents the first step in an overall strategy to improve client side performance as follows:

    Reduce the file size of each resource
    Only deliver a resource that is needed
    Combine resources into as few as possible


Solution Characteristics»
DotNetNuke 6.1 has these characteristics which lay the building blocks for achieving the goals mentioned above:

    Resource Registration API to request that a JS or CSS resource be loaded
    Combines all requests of a given type into composite files on a per-page basis
    Caches the combined files and persists on disk
    Reuse of cached files across pages if appropriate
    Allows for cache busting based on versioning scheme


The Client Dependency Framework»
The Client Dependency Framework (CDF), was adopted in DotNetNuke 6.1 to perform the bulk of the heavy lifting. Here are some facts about the CDF:

    It is an Open Source Framework (http://clientdependency.codeplex.com)
    Licensed under the Microsoft Public License (Ms-PL)
    Originally released in early 2010
    Supports both ASP.NET MVC & ASP.NET WebForms
    Used in Umbraco
    Meets all key characteristics mentioned in "solution characteristics" above


Implementation Details»
Several enhancements have been made to the DotNetNuke framework to integrate and make use of the CDF.

    ClientResourceManager is the central location for the new API
    A File Order Enumeration was created to help define the order of core files
    New CDF Providers were created to define the location at which various files would render in the document
    Default.aspx and Installer.aspx were enhanced to incorporate centralized resource registration
    jQuery registration was updated to use the new API
    The WebControls and WebUtility projects were updated to use the new API (except for dnn.js)
    Various CSS and JS registrations were updated to use the new API throughout the framework
    A Cache invalidation strategy was created so updates to existing files would be recognized
    Dynamic minification of files is performed using JS Min and can be toggled in the web.config


A New Approach»
There are a few key concepts that allow developers to work more easily:

    Can use the "debug" version of files, no need to minify
    Can break out "overloaded" files into multiple files (logical separation of concerns) and register as appropriate


The API itself»
There are a variety of ways to interact with the new API. Below describes several common scenarios/topics:

New User Controls: DnnJsInclude and DnnCssInclude»
There are two new user controls available in DNN 6.1: DnnJsInclude and DnnCssInclude. Here are a few usage examples taken from the Dark Knight skin:

<%@ Register TagPrefix="dnn" Namespace="DotNetNuke.Web.Client.ClientResourceManagement" Assembly="DotNetNuke.Web.Client" %>

<dnn:DnnJsInclude runat="server" FilePath="jquery.cycle.min.js" PathNameAlias="SkinPath" />
<dnn:DnnJsInclude runat="server" FilePath="DNNMega/jquery.dnnmega.debug.js" PathNameAlias="SkinPath" />
<dnn:DnnCssInclude runat="server" FilePath="DNNMega/dnnmega.css" PathNameAlias="SkinPath" />
<dnn:DnnJsInclude runat="server" FilePath="~/Resources/Shared/Scripts/jquery/jquery.hoverIntent.min.js" />


The above controls expose the following key properties that can be set:

    FilePath is the path to the file to be loaded
    PathNameAlias is a reference to a common folder location. Right now we have established two: "SkinPath" (the path to the current skin) and "SharedScripts" (~/Resources/Shared/Scripts/).
    Priority is an integer based scheme for determining the file load order. The default priority is 100. See the Relative Order section below for more information.
    ForceProvider is a string value that specifies what provider to be used. This corresponds to the location in the page where the script will be rendered. See the Providers section below for more information.


DotNetNuke.Web.Client»
If you'd like to register a resource file in code, you can do so using the ClientResourceManager found in DotNetNuke.Web.Client. First add a reference to the assembly, and then make use of any of the API methods listed below. For more information about priority and providers, please see their respective sections below.

There are a few different overloads for registering a stylesheet, the most common is listed first:

RegisterStyleSheet(Page page, string filePath) //default provider and default priority
RegisterStyleSheet(Page page, string filePath, int priority) // default provider
RegisterStyleSheet(Page page, string filePath, FileOrder.Css priority) // default provider, uses FileOrder enumeration (primarily for internal framework use)
RegisterStyleSheet(Page page, string filePath, int priority, string provider)


There are also a few overloads for registering a JavaScript file, again, the most common are listed first.

RegisterScript(Page page, string filePath) // default priority and provider
RegisterScript(Page page, string filePath, int priority) // default provider
RegisterScript(Page page, string filePath, FileOrder.Js priority) // default provider, uses fileorder enumeration
RegisterScript(Page page, string filePath, FileOrder.Js priority, string provider) // no defaults
RegisterScript(Page page, string filePath, int priority, string provider) // no defaults


Relative Order»
There is an enumeration that defines the file load order (priority) of each of the internal files that the DNN framework is responsible for loading. They have been spaced out a bit so that an extension developer can sneak their files in wherever they like.

Note: the FileOrder enumeration is not intended to be used outside of the core application. For instance, if you want to register something after jQuery but before jQuery UI - you would use a value of 6,7,8 or 9 when registering the script. Or you could use your own enumeration (e.g. MyFileOrder.AfterjQueryBeforejQueryUI) to give a good name to the number.

JavaScript priorities:

Default: 100
jQuery: 5
jQuery UI: 10
DnnXxml: 15
DnnXmlJsParser: 20
DnnXmlHttp: 25
DnnXmlHttpJsXmlHttpRequest: 30
DnnDomPositioning: 35
DnnControls: 40
DnnControlsLabelEdit: 45


CSS priorities:

DefaultCss: 5
ModuleCss: 10
SkinCss: 15
SpecificSkinCss: 20
ContainerCss: 25
SpecificContainerCss: 30
PortalCss: 35


Providers: dictating the file's location within the document»
By specifying a provider, you can dictate where the file will load in the page. CSS all loads in the DnnPageHeaderProvider by default. DnnBodyProvider is the default for JavaScript files.

The following providers are available and will be useful for JavaScript:

    DnnPageHeaderProvider: adds the file to a specific location within the head
    DnnBodyProvider: adds the file to the top of the body (most framework-level files are loaded here, as that's how it has always worked in the past and there are several dependencies within the body on the framework-level files)
    DnnFormBottomProvider: adds the file to the bottom of the body (primarily for scripts that have a dependency on the ClientAPI's __dnnVariable which is rendered at the bottom of the page)


Important Note: file combining and ordering is done by the framework at the file registration provider level! As well as duplication detection/removing! Please take this into account when registering files.

Debugging»
The combination and minification of files can be disabled by setting the web.config's debug mode to true.

Versioning»
Versioning is done through an integer value specified in the web.config. DNN increments the number when an extension is installed, a DNN upgrade is performed, the cache is cleared (in the host settings), or portal.css is updated through the user interface. Each of these actions will increment the version number, which triggers a rebuild of the cache. This also necessarily means that the application will recycle.

Using the API from a custom ASPX page (possible, but not recommended)»
This should not be a common scenario, but in some cases you may need to register JS files from a custom physical ASPX page within DNN. If that is the case - you will need to mimic several relevant pieces from Default.aspx and also reference DotnetNuke.Web.Client.dll.

While the current items below should not change, there may be new elements introduced over time that you would also need to replicate, so be warned that this is not a completely optimal/safe usage scenario. There is no guarantee that upgrading DNN will not break or limit this usage scenario, as these are technically internal DNN implementation details that are duplicated to accommodate a non-standard scenario.

The ClientResourceManagement register directive, placed at the top of the page:

<%@ Register TagPrefix="dnncrm" Namespace="DotNetNuke.Web.Client.ClientResourceManagement" Assembly="DotNetNuke.Web.Client" %>


This placeholder for rendering resources should be located near the bottom of the head element:

<asp:PlaceHolder runat="server" ID="ClientDependencyHeadCss"></asp:PlaceHolder>
<asp:PlaceHolder runat="server" ID="ClientDependencyHeadJs"></asp:PlaceHolder>


This placeholder for rendering resources should be located at the top (but still inside) of the form element:

<asp:PlaceHolder ID="BodySCRIPTS" runat="server" />


This placeholder for rendering resources should be located at the bottom (but still inside) of the form element:

<asp:placeholder runat="server" ID="ClientResourcesFormBottom" />


The Client Resource Loader control and the placeholder for dynamic placeholder in which includes are added - these should be placed below (outside) the form element:

<asp:placeholder runat="server" id="ClientResourceIncludes" />
<dnncrm:ClientResourceLoader runat="server" id="ClientResourceLoader">
        <Paths>
            <dnncrm:ClientResourcePath Name="SkinPath" Path="<%# CurrentSkinPath %>" />
            <dnncrm:ClientResourcePath Name="SharedScripts" Path="~/Resources/Shared/Scripts/" />
        </Paths>
</dnncrm:ClientResourceLoader>

            -->
        </ul>
    </div>
    <div id="sponsors" class="step" data-x="11000" data-rotate="180">
        <h3>Thanks to all our Generous Sponsors!</h3>
        <a id="dnn-logo" href="http://www.dotnetnuke.com/"><img src="img/DotNetNuke.png" alt="DotNetNuke" /></a>
        <a href="http://www.PowerDNN.com/"><img src="img/PowerDnn.png" alt="PowerDNN" /></a>
        <a href="http://uncc.edu/"><img src="img/UNC%20Charlotte.png" alt="University of North Carolina at Charlotte" /></a>
        <a href="http://www.engagesoftware.com/"><img src="img/Engage.png" alt="Engage Software" /></a>
        <a href="http://www.aspose.com/"><img src="img/Aspose.png" alt="Aspose" /></a>
        <a href="http://www.packflash.com/"><img src="img/PackFlash.png" alt="PackFlash" /></a>
        <a href="http://www.arrownuke.com/"><img src="img/Arrow%20Consulting%20%26%20Design.png" alt="Arrow Consulting &amp; Design" /></a>
        <a href="http://www.appliedi.net/"><img src="img/Applied%20Innovations.png" alt="Applied Innovations" /></a>
        <a href="http://www.cfwebmasters.com/"><img src="img/CF%20Webmasters.png" alt="Cape Fear Webmasters" /></a>
        <a href="http://enlivenstudio.com/"><img src="img/enliven.png" alt="Enliven Studio" /></a>
        <a href="http://coolcoyotes.com/"><img src="img/Cool%20Coyotes.png" alt="Cool Coyotes" /></a>
        <a href="http://www.iowacomputergurus.com/"><img src="img/Iowa%20Computer%20Gurus.png" alt="Iowa Computer Gurus" /></a>
        <a href="http://www.roberthalftechnology.com/"><img src="img/Robert%20Half%20Technology.png" alt="Robert Half Technology" /></a>
        <a href="http://dnndev.com/"><img src="img/DNN%20Dev.jpg" alt="DNNDev" /></a>
        <a href="https://www.technicalcommunity.com/Pages/default.aspx"><img src="img/Microsoft%20UGSS.png" alt="Microsoft User Group Support Services" /></a>
        <a href="http://www.infragistics.com/"><img src="img/Infragistics.png" alt="Infragistics" /></a>
        <a href="http://logicaladvantage.com/"><img src="img/Logical%20Advantage.png" alt="Logical Advantage" /></a>
        <a href="http://www.spiffywebteam.com/"><img src="img/Spiffy.png" alt="Spiffy Web Team" /></a>
        <a href="http://www.pointclick.net/"><img src="img/PointClick%20Technologies.png" alt="PointClick Technologies" /></a>
    </div>
</div>

<div class="hint">
    <p>Use a spacebar or arrow keys to navigate</p>
</div>
<script src="js/LAB.min.js"></script>
<script>
$LAB
.script("js/impress.js")
.script("js/shCore.js").wait()
.script("js/shBrushCSharp.js")
.script("js/shBrushJScript.js")
.wait(function () {
    SyntaxHighlighter.all();
    window.h5pCaniuse = function(a) { document.getElementById("fallback-browsers").innerHTML=a.html; };
}).script("http://api.html5please.com/csstransforms3d+classlist+dataset.json?callback=h5pCaniuse&texticon&nocss&html");
</script>
</body>
</html>